{"version":3,"sources":["../src/createSurface.js"],"names":["React","require","Component","PropTypes","invariant","fill","resolve","build","Shaders","Node","postShader","findGLNodeInGLComponentChildren","invariantStrictPositive","AnimatedData","runtime","_glSurfaceId","logResult","data","contentsVDOM","console","debug","module","exports","renderVcontainer","renderVcontent","renderVGL","getPixelRatio","getGLCanvas","glSurface","refs","canvas","GLSurface","props","context","_renderId","_id","_onSurfaceWillMount","_build","_attach","_onSurfaceWillUnmount","_dataAnimated","__detach","nextProps","id","renderId","width","height","pixelRatioProps","pixelRatio","children","preload","decorateOnShaderCompile","onShaderCompile","error","result","surfaceContext","glNode","t","childGLNode","via","resolved","_beforeSurfaceBuild","e","_afterSurfaceBuild","_resolved","_pixelRatio","oldDataAnimated","callback","setNativeProps","__getValue","forceUpdate","c","captureFrame","apply","arguments","imagesToPreload","style","backgroundColor","visibleContent","eventsThrough","restProps","process","env","NODE_ENV","withoutKeys","filter","key","length","warn","map","type","name","displayName","join","vdom","i","decorateVDOMContent","nbContentTextures","propTypes","any","isRequired","string","number","element","bool","autoRedraw","onLoad","func","onProgress","defaultProps"],"mappings":"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","file":"createSurface.js","sourcesContent":["const React = require(\"react\");\nconst {\n  Component,\n  PropTypes\n} = React;\nconst invariant = require(\"invariant\");\nconst { fill, resolve, build } = require(\"./data\");\nconst Shaders = require(\"./Shaders\");\nconst Node = require(\"./Node\");\nconst postShader = require(\"./postShader\");\nconst findGLNodeInGLComponentChildren = require(\"./data/findGLNodeInGLComponentChildren\");\nconst invariantStrictPositive = require(\"./data/invariantStrictPositive\");\nconst AnimatedData = require(\"./AnimatedData\");\nconst runtime = require(\"./runtime\");\n\nlet _glSurfaceId = 1;\n\nfunction logResult (data, contentsVDOM) {\n  if (typeof console !== \"undefined\" &&\n    console.debug // eslint-disable-line\n  ) {\n    console.debug(\"GL.Surface rendered with\", data, contentsVDOM); // eslint-disable-line no-console\n  }\n}\n\nmodule.exports = (\n  renderVcontainer,\n  renderVcontent,\n  renderVGL,\n  getPixelRatio,\n  getGLCanvas = glSurface => glSurface.refs.canvas,\n) => {\n\n  class GLSurface extends Component {\n    constructor (props, context) {\n      super(props, context);\n      this._renderId = 0;\n      this._id = _glSurfaceId ++;\n    }\n\n    componentWillMount () {\n      Shaders._onSurfaceWillMount(this._id);\n      this._build(this.props);\n      this._attach();\n    }\n\n    componentWillUnmount () {\n      this._renderId = 0;\n      Shaders._onSurfaceWillUnmount(this._id);\n      this._dataAnimated && this._dataAnimated.__detach();\n    }\n\n    componentWillReceiveProps (nextProps) {\n      this._build(nextProps);\n      this._attach();\n    }\n\n    _build (props) {\n      const id = this._id;\n      const renderId = ++this._renderId;\n      const {\n        width,\n        height,\n        pixelRatio: pixelRatioProps,\n        children,\n        debug,\n        preload\n      } = props;\n\n      invariant(children, \"GL.Surface must have in children a GL.Node or a GL Component\");\n\n      const decorateOnShaderCompile = onShaderCompile =>\n      onShaderCompile && // only decorated if onShaderCompile is defined\n      ((error, result) =>\n        renderId === this._renderId && // it's outdated. skip the callback call\n        onShaderCompile(error, result)); // it's current. propagate the call\n\n      const pixelRatio = pixelRatioProps || getPixelRatio(props);\n\n      invariantStrictPositive(pixelRatio, \"GL.Surface: pixelRatio prop\");\n\n      const surfaceContext = {\n        width,\n        height,\n        pixelRatio\n      };\n\n      const glNode = findGLNodeInGLComponentChildren(\n        <Node\n          shader={postShader}\n          {...surfaceContext}\n          uniforms={{ t: children }}\n        />,\n        surfaceContext);\n\n      invariant(glNode && glNode.childGLNode, \"GL.Surface must have in children a GL.Node or a GL Component\");\n\n      const { via, childGLNode, context } = glNode;\n\n      let resolved;\n      try {\n        Shaders._beforeSurfaceBuild(id);\n        resolved =\n          resolve(\n            fill(\n              build(\n                childGLNode,\n                context,\n                preload,\n                via,\n                id,\n                decorateOnShaderCompile\n              )));\n      }\n      catch (e) {\n        throw e;\n      }\n      finally {\n        Shaders._afterSurfaceBuild(id);\n      }\n\n      this._resolved = resolved;\n      this._pixelRatio = pixelRatio;\n\n      if (debug) logResult(resolved.data, resolved.contentsVDOM);\n    }\n\n    _attach () {\n      const oldDataAnimated = this._dataAnimated;\n      const callback = () => {\n        const canvas = this.getGLCanvas();\n        if (!canvas) return;\n        if (canvas.setNativeProps) {\n          const data = this._dataAnimated.__getValue();\n          canvas.setNativeProps({ data });\n        }\n        else {\n          this.forceUpdate();\n        }\n      };\n      this._dataAnimated = new AnimatedData(\n        this._resolved.data,\n        callback);\n\n      oldDataAnimated && oldDataAnimated.__detach();\n    }\n\n    getGLCanvas () {\n      return getGLCanvas(this);\n    }\n\n    captureFrame () {\n      const c = this.getGLCanvas();\n      invariant(c, \"c is '%s'. Is the component unmounted?\", c);\n      invariant(c.captureFrame, \"captureFrame() should be implemented by GLCanvas\");\n      return c.captureFrame.apply(c, arguments);\n    }\n\n    render() {\n      const renderId = this._renderId;\n      const { contentsVDOM, imagesToPreload } = this._resolved;\n      const data = this._dataAnimated.__getValue();\n      const pixelRatio = this._pixelRatio;\n      const props = this.props;\n      const {\n        children, debug, preload, // eslint-disable-line no-unused-vars\n        style,\n        width,\n        height,\n        backgroundColor,\n        visibleContent,\n        eventsThrough,\n        ...restProps\n      } = props;\n\n      if (process.env.NODE_ENV !== \"production\") {\n        const withoutKeys = contentsVDOM.filter(c => !c.key);\n        if (withoutKeys.length > 0) {\n          console.warn(\n`gl-react: To avoid potential remounting, please define a \\`key\\` prop on your contents:\n\n${withoutKeys.map(c => \"<\"+(c.type.name || c.type.displayName || \"unknown\")+\" key=??? ... />\").join(\"\\n\")}\n`);\n        }\n      }\n\n      return renderVcontainer(\n        { width, height, style, visibleContent, eventsThrough },\n        contentsVDOM.map((vdom, i) =>\n          renderVcontent(data.width, data.height, vdom.key || i, runtime.decorateVDOMContent(vdom), { visibleContent })),\n        renderVGL({\n          ...restProps, // eslint-disable-line no-undef\n          style: { backgroundColor },\n          width,\n          height,\n          pixelRatio,\n          data,\n          nbContentTextures: contentsVDOM.length,\n          imagesToPreload,\n          renderId,\n          visibleContent,\n          eventsThrough\n        })\n      );\n    }\n  }\n\n  GLSurface.displayName = \"GL.Surface\";\n\n  GLSurface.propTypes = {\n    width: PropTypes.any.isRequired,\n    height: PropTypes.any.isRequired,\n    backgroundColor: PropTypes.string,\n    pixelRatio: PropTypes.number,\n    children: PropTypes.element.isRequired,\n    preload: PropTypes.bool,\n    autoRedraw: PropTypes.bool,\n    eventsThrough: PropTypes.bool,\n    visibleContent: PropTypes.bool,\n    onLoad: PropTypes.func,\n    onProgress: PropTypes.func\n  };\n\n  GLSurface.defaultProps = {\n    preload: false,\n    autoRedraw: false,\n    eventsThrough: false,\n    visibleContent: false,\n    backgroundColor: \"#000\"\n  };\n\n  return GLSurface;\n};\n"]}